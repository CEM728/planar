## Near-field profile under gaussian-beam illumination
_baptiste AuguiÃ© -- `r format(Sys.time(), "%d %B, %Y")`_

Using the angular spectrum decomposition of a gaussian beam in a bundle of plane waves, the near-field profile is calculated on the transmitted side of an interface illuminated under total internal reflection.

```{r , echo=FALSE,results='hide'}
library(knitr)
library(ggplot2)
library(rgl)
knit_hooks$set(rgl = function(before, options, envir) {
  # if a device was opened before this chunk, close it
  if (before && rgl.cur() > 0) rgl.close()
  hook_rgl(before, options, envir)
})
opts_chunk$set(fig.path="gaussianbeam/", cache=TRUE, cache.path="gaussian/",
               warning=FALSE,error=FALSE,message=FALSE,tidy=FALSE)
library(ggplot2)
theme_set(theme_minimal() + theme(panel.border=element_rect(fill=NA)))
```

#### Setting up

```{r , results='hide'}
library(planar)
library(ggplot2)
library(plyr)
w0 <- 1e3 # beam waist 1 micron
alpha <- 70*pi/180 # incident angle
```

## Depth profile

```{r depth}
xyz <- as.matrix(expand.grid(x=seq(0,1e4,length=20), y=0, z=seq(1, 500, length=50)))
res <- adply(xyz, 1, gaussian_field, d=50, nl=sqrt(epsAu(633)$epsilon),
             wavelength=633, w0=5e3, ni=1.5+0i, alpha=45, maxEval=1000)
xyz <- data.frame(xyz, field=res[[2]])
ggplot(xyz, aes(z, field, colour=x, group=x))+
  geom_line() +scale_y_log10()+
  labs(x=expression("z /nm"), y=expression(log("|E|"^2)), 
       colour=expression("x /nm")) 

```
We observe that the field decays exponentially away from the interface with the same characteristic distance across the beam profile.

## Goos-Hanshen shift

Under total-internal reflection, the beam undergoes a spatial displacement known as Goos-Hanshen shift. The centre of the beam is displaced from the origin.

```{r GH}
w0 <- 1000
xyz <- as.matrix(expand.grid(x=seq(-5*w0, 15*w0,length=100), y=0, z=seq(0, 500, by=50)))
res <- adply(xyz, 1, gaussian_field, d=50, nl=sqrt(epsAu(633)$epsilon),
             wavelength=633, w0=w0, ni=1.5+0i, alpha=44.5*pi/180, maxEval=2000)
xyz <- data.frame(xyz, field=res[[2]])

ggplot(xyz, aes(x, field, colour=z, group=z))+
  geom_line() +
  geom_vline(aes(x=0,y=NULL),lty=2) +
  labs(x=expression("x /nm"), y=expression("|E|"^2), 
       colour=expression("z /nm")) 
```

## 2D map

We can calculate the field at a grid of points in 2D or 3D. Here is the result for a slice at $z=10$nm.

```{r map}
w0 <- 2000
xyz <- as.matrix(expand.grid(x=seq(-3*w0, 5*w0, length=50), 
                             y=seq(-3*w0, 3*w0, length=50),
                             z=10))
res <- adply(xyz, 1, gaussian_field, d=50, nl=sqrt(epsAu(633)$epsilon),
             wavelength=633, w0=w0, ni=1.5+0i, alpha=44.5*pi/180, maxEval=500)
xyz <- data.frame(xyz, field=res[[2]])

  ggplot(xyz, aes(x/1e3, y/1e3, fill=field))+
  geom_raster(interpolate=TRUE) +
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0)) +
  labs(x=expression("x /nm"), fill=expression("|E|"^2), 
       y=expression("y /nm")) +
  coord_fixed()

```

```{r volume, rgl=TRUE}
w0 <- 2000
xyz <- as.matrix(expand.grid(x=seq(-5*w0, 5*w0, length=30), 
                             y=seq(-3*w0, 3*w0, length=30),
                             z=seq(2, 1000, length=30)))
                             
res <- adply(xyz, 1, gaussian_field, d=50, nl=sqrt(epsAu(633)$epsilon),
             wavelength=633, w0=w0, ni=1.5+0i, alpha=44.5*pi/180, maxEval=500)
xyz <- data.frame(xyz, field=res[[2]])

sprites3d(xyz[,1], xyz[,2], xyz[,3]*10 ,radius=1000,lit=FALSE, alpha=.1,
        color=grey(scales::rescale(xyz[,4], to=c(0.9,0))))
```



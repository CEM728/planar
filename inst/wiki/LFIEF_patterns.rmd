Applying optical reciprocity to the problem of dipolar emission near a planar interface, we can obtain the radiation pattern (intensity vs angle) by modelling the near-field at the dipole location for plane-wave illumination at a range of incident angles.

```{r , echo=FALSE,results='hide'}
opts_chunk$set(fig.path="lfiefpattern/",
               warning=FALSE,error=FALSE,message=FALSE,tidy=FALSE)
library(ggplot2)
theme_set(theme_minimal() + theme(panel.border=element_rect(fill=NA)))
```

```{r setup, results='hide'}
library(planar)
library(ggplot2)
require(reshape2)
```

### Dipole in a vacuum

We first confirm that the dipolar emission in a vacuum follows the expected `sin^2` pattern. We define a dummy simulation (no actual interface),

```{r dummy, fig.show='hold', fig.width=5,fig.height=5}
## radiation pattern of a dipole in a vacuum
## parallel and perpendicular orientations, p- polarisation

## from left to right
## incident air | air

back <- list(lambda=632.8,
             theta = seq(0, 180, length=100)* pi/180, 
             epsilon = list(1.0^2, 1.0^2),
             thickness = c(0, 0),
             d = 1,
             polarisation = 'p')

front <- invert_stack(back)

## simulation
M.front <- do.call(multilayer, front)
M.back <- do.call(multilayer, back)

theta <- c(back$theta , 2*pi-rev(back$theta) ) * 180 / pi
## look at field in first and last media
last <- length(M.back$Mr.par)
intensity.par = c(M.front$Ml.par[[1]] , M.back$Mr.par[[last]])
intensity.perp = c(M.front$Ml.perp[[1]] , M.back$Mr.perp[[last]])

combined <- data.frame(theta=theta, parallel=intensity.par,
                       perpendicular=intensity.perp,
                       side = gl(2, length(M.front$q)))

## basic plot
qplot(theta, perpendicular, colour=side, data=combined, geom="line")

## polar plot with two variables
m <- melt(combined, id=c("theta", "side"))

mylabels <- c(-90,-45,0,45,90, 45,0,-45)

ggplot(m, aes(theta, value)) +
  geom_polygon(aes(fill=variable,colour=variable), alpha=0.5)  +
  scale_x_continuous(breaks = seq(0, 360-45, by = 45), labels=mylabels,
                     limits = c(0, 360), expand = c(0, 0)) +
  coord_polar(start=0) +
  scale_fill_brewer(palette = "Pastel1") +
  scale_colour_brewer(palette = "Set1") +
  labs(x = "angle / degrees", y = "LFIEF", fill = "side",linetype="Orientation") +
  guides(fill="none",colour="none")

```

### Dipole near a thin gold film (Kretschmann configuration)

In the Kretschmann configuration, molecules situated on the air side will radiate predominantly in a narrow cone of angles, associated with the excitation of surface plasmon-polaritons (SPPs) radiating into the glass substrate. By reciprocity, the field enhancement experienced by a dipole near the metal layer is also obtained for a narrow range of angles where conservation of in-plane momentum between the incident light and the SPPs is satisfied.

```{r kretschmann, fig.width=11}
## from left to right
## incident air | metal | glass

back <- list(lambda=632.8,
             theta = seq(-90, 90, length=1e4)[-c(1, 1e4)] * pi/180, 
             epsilon = list(1.52^2, epsAg(632.8)$epsilon, 1.0^2),
             thickness = c(0, 50, 0),
             d = 1,
             polarisation = 'p')


front <- invert_stack(back)

## simulation
M.front <- do.call(multilayer, front)
M.back <- do.call(multilayer, back)

theta <- c(back$theta + pi/2, back$theta + 3*pi/2) * 180 / pi
## look at field in first and last media
last <- length(M.back$Mr.par)
intensity.par = c(M.front$Ml.par[[1]] , M.back$Mr.par[[last]])
intensity.perp = c(M.front$Ml.perp[[1]] , M.back$Mr.perp[[last]])

combined <- data.frame(theta=theta, parallel=intensity.par,
                       perpendicular=intensity.perp,
                       side = gl(2, length(M.front$q)))

## polar plot with two variables
m <- melt(combined, id=c("theta", "side"))

mylabels <- c(-90,-45,0,45,90, 45,0,-45)

ggplot(m, aes(theta, value, group=interaction(side,variable))) +
  facet_wrap(~variable, ncol=2) +
  annotate("rect", xmin=180,xmax=360,ymin=1e-2,ymax=100,fill="grey95",alpha=0.5) +
  annotate("rect", xmin=0,xmax=360,ymin=1e-2,ymax=1,fill=NA,colour="grey50",lty="dashed") +
  geom_polygon(aes(fill=side), alpha=0.5,colour=NA)  +
  geom_line(aes(colour=side), alpha=0.5)  +
  scale_x_continuous(breaks = seq(0, 360-45, by = 45), labels=mylabels,
                     limits = c(0, 360), expand = c(0, 0)) +
  scale_y_log10(lim=c(1e-2, 200)) +
  coord_polar(start=3*pi/2) +
  annotate("segment", x=360, xend=360, y=0, yend=2, colour="orange", size=2) +
  annotate("segment", x=180, xend=180, y=0, yend=2, colour="orange", size=2) +
  scale_fill_brewer(palette = "Pastel1") +
  scale_colour_brewer(palette = "Set1") +
  labs(x = NULL, y = "LFIEF", fill = "side",linetype="Orientation") +
  guides(fill="none",colour="none")

```



